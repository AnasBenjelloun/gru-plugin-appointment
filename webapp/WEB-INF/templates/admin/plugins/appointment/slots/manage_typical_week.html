<#include "/admin/plugins/appointment/appointmentform/modify_appointmentform_tabs_planning.html" />
<script src="js/jquery/jquery-1.11.3.min.js"></script>
<script src="js/query/jquery-ui.min.js"></script>
<script src="js/plugins/appointment/moment.min.js" ></script>
<script src="js/plugins/appointment/fullcalendar.min.js"></script>
<script src="js/plugins/appointment/locale-all.js"></script>
<script src="js/plugins/appointment/bootstrap-datepicker.js" ></script>
<script src="js/locales/bootstrap-datepicker.fr.js" ></script>
<script src="js/plugins/appointment/bootstrap-datetimepicker.min.js"></script>
<link rel="stylesheet" href="js/plugins/appointment/fullcalendar.min.css" >
<link rel='stylesheet' href='css/plugins/appointment/bootstrap-datetimepicker.css' />
<style>
.ui-widget-header {
    border: 1px solid #aaa;
    background: none;
    color: #222;
    font-weight: normal;
}

#toggle-add-comment{
    position: absolute;
    z-index: 999;
    top: 197px;
    left: 33px;
    background-color: rgb(233, 250, 0);
    border-color:rgb(233, 250, 0);
    color: rgb(0, 0, 0);
}

th.fc-day-header {
    height: auto !important;
   padding: 5px 20px !important;
}

.btn-comments{ 
    position:absolute; right:5px; top: 0 ;z-index:99; 
}

.fc-content{ 
    text-align:center;
}

.fc-content .fc-title i.fa-plus{
    position: absolute;
    right: 30px;
    top: 8px;
    z-index: 1;
    display: none;
    width: 15px
}

.fc-content:hover .fc-title  i.fa-plus{
    display: block;
} 

/* Begin From fullcalendar_ow_bo.css */
/* Line size */
.fc-time-grid .fc-slats td, th.fc-day-header, .fc-axis.fc-time {    
    height: 50px ; 
}


.fc-ltr .fc-time-grid .fc-event-container {
	margin: 0 2px;
    padding:0;
}

.fc-axis.fc-time {
    width: 100px ;
    padding: 4px auto;
    text-align: center;
    line-height: 1.42857143;
    width: 130px;
    margin: 0;
    border-top: 0px solid transparent;   
    border-right: solid 1px rgb(190, 190, 190); 
}

.fc-day-grid-event.fc-h-event.fc-event.fc-start.fc-end{
    background-color: rgb(233, 250, 0);
    border-color:rgb(233, 250, 0);
    color: rgb(0, 0, 0);
}

th.fc-day-header {    
    padding: 15px 20px;
    text-align: center;
    line-height: 1.42857143;
    margin: 0;
    border-top: 0px solid transparent;
	font-weight: normal;
	vertical-align: middle;
}

.fc-time-grid-event .fc-time, .fc-time-grid-event .fc-title {
	padding: 5px; 
}

.fc-title a{
    display: inline-block;
    padding-top: 5px;
    font-weight: 700;
    color: #000
}

.fc-title p{
    width: 80%;
    white-space: nowrap;
  	overflow: hidden;
  	text-overflow: ellipsis;
    margin: 0;
    text-align: left;
}

.fc-title p:not(:first-child){
   display: none;
}

.fc-helper{ 
    background-color: rgba(0, 250, 54, .5);
    border: 2px solid  rgb(2, 145, 33);
}

/* End fullcalendar_ow_bo.css         */
/*** NEW                            ***/
.tab-content{ margin-bottom: 5rem ;}

/*** Overbooked                     ***/
.overbooked.bg-full{ 
    background: rgba(255, 165, 0, 1) !important; 
    
}

.overbooked{ 
    background: none !important;
}

.overbooked.bordered{ 
    border-right: 15px solid rgba(255, 165, 0, 1) !important 
}

.overbooked.bordered .fc-title a > i.fa-plus-circle::before{
    right: 17px;
}

.overbooked.dotted .fc-title::after{
    content: "\f111";
    font-family: "FontAwesome";
    color: rgba(255, 165, 0, 1);
    position: absolute;
    right: 15px;
    top: 5px;
    display: inline-block;
}

/*** FILLED         ***/
.filled{ 
    background: none !important;
}

.filled.bg-full{ 
 background:  rgba(255,0,0,1) !important;
}

.filled.bordered{ 
    border-right: 15px solid  rgba(255,0,0,1)  !important;
}

.filled.bordered .fc-title a > i.fa-plus-circle::before{
    right: 17px;
} 

.filled.dotted .fc-title::after{
    content: '\f111';
    font-family: 'FontAwesome';
    color:  rgba(255,0,0,1);
    position: absolute;
    right: 15px;
    top: 5px;
    display: inline-block;
}

/* SELECTABLE */
.ui-selectable-helper{
    border: 4px dotted rgba( 0, 248, 41, 1);
    border-radius: 0;
    background-color: rgba(0, 248, 41, 0.5);    
}
</style>
<@row>
	<@columns>
		<@messages infos=infos errors=errors />
		<@appointmentTabs tab='typicalWeek' appointmentform=appointmentform>
			<@tform type='inline' action='jsp/admin/plugins/appointment/ManageAppointmentSlots.jsp?view=manageTypicalWeek' id='listOfDates' params='enctype="multipart/form-data"'>
					<@input type='hidden' id='id_form' name='id_form' value='${appointmentform.idForm}' />



					<#if listDateOfModification??>
						<@formGroup formStyle='inline' labelFor='id_week_definition' labelKey='#i18n{appointment.modifyAppointmentForm.listDateOfModification}'>
							<@inputGroup>
								<@select id='id_week-definition' name='id_week_definition' size='sm'>
									<#list listDateOfModification as item>
										<#if "${id_week_definition}"="${item.code}">
											<option selected="selected" value="${item.code}">${item.name}</option>
										<#else>
											<option value="${item.code}">${item.name}</option>
										</#if>
									</#list>
								</@select>
								<@inputGroupItem>
									<@button type='submit' name='view_manageTypicalWeek' title='#i18n{appointment.labelDisplay}' hideTitle=['xs'] buttonIcon='check' size='sm' />
									<@button type='submit' name='action_confirmRemoveParameter' title='#i18n{portal.util.labelDelete}' hideTitle=['xs'] buttonIcon='trash' size='sm' color='danger' />
								</@inputGroupItem>
							</@inputGroup>
						</@formGroup>
					</#if>
				</@tform>

				<@box collapsed=!error_modification??>
					<#if !error_modification??>
						<#assign appointmentTypicalWeekAdvancedIcon = 'plus' />
					<#else>
						<#assign appointmentTypicalWeekAdvancedIcon = 'minus' />
					</#if>
					<@boxHeader title='#i18n{appointment.modifyAppointmentForm.titleStructuralsParameters}'>
						<@button style='card-control collapse' buttonIcon='${appointmentTypicalWeekAdvancedIcon}' />
					</@boxHeader>
					<@boxBody>
						<@tform action='jsp/admin/plugins/appointment/ManageAppointmentSlots.jsp' params='enctype="multipart/form-data"'>
							<@input type='hidden' id='id_form' name='id_form' value='${appointmentform.idForm}' />
							<@input type='hidden' id='bo_overbooking' name='bo_overbooking' value='${appointmentform.boOverbooking?then("true", "false")}'/> 
							<@input type='hidden' id='is_multislot_appointment' name='is_multislot_appointment' value='${appointmentform.isMultislotAppointment?then("true", "false")}'/>                        
							<@formGroup labelFor='time_start' labelKey='#i18n{appointment.createAppointmentForm.labelTimeStart}' helpKey='#i18n{appointment.createAppointmentForm.labelTimeStart.help}' mandatory=true>
								<@inputGroup>
									<@inputGroupItem type='text'>
										<@icon style='clock-o' />
									</@inputGroupItem>
									<@input type='text' name='time_start' id='time_start' value=appointmentform.timeStart!'' />
								</@inputGroup>
							</@formGroup>
							<@formGroup labelFor='time_end' labelKey='#i18n{appointment.createAppointmentForm.labelTimeEnd}' helpKey='#i18n{appointment.createAppointmentForm.labelTimeEnd.help}' mandatory=true>
								<@inputGroup>
									<@inputGroupItem type='text'>
									  <@icon style='clock-o' />
									</@inputGroupItem>
									<@input type='text' name='time_end' id='time_end' value=appointmentform.timeEnd!'' />
								</@inputGroup>
							</@formGroup>
							<@formGroup labelFor='duration_appointments' labelKey='#i18n{appointment.createAppointmentForm.labelDurationAppointments}' helpKey='#i18n{appointment.createAppointmentForm.labelDurationAppointments.help}' mandatory=true>
								<@input type='text' name='duration_appointments' id='duration_appointments' value=appointmentform.durationAppointments!'' params='onkeypress="return validateQty(event);"' maxlength=3 />
							</@formGroup>
							<@formGroup labelFor='max_capacity_per_slot' labelKey='#i18n{appointment.createAppointmentForm.labelMaxCapacityPerSlot}' helpKey='#i18n{appointment.createAppointmentForm.labelMaxCapacityPerSlot.help}' mandatory=true>
								<@input type='text' name='max_capacity_per_slot' id='max_capacity_per_slot' value=appointmentform.maxCapacityPerSlot!'' params='onkeypress="return validateQty(event);"' maxlength=3 />
							</@formGroup>
							<#if !appointmentform.isMultislotAppointment >
								<@formGroup labelFor='max_people_per_appointment' mandatory=true labelKey='#i18n{appointment.createAppointmentForm.labelMaxPeoplePerAppointment}' helpKey='#i18n{appointment.createAppointmentForm.labelMaxPeoplePerAppointment.help}' mandatory=true>
									<@input type='text' name='max_people_per_appointment' id='max_people_per_appointment' value=appointmentform.maxPeoplePerAppointment!'' params='onkeypress="return validateQty(event);"' maxlength=3 />
								</@formGroup>
							</#if>	
							<legend>#i18n{appointment.createAppointmentForm.labelTitleDaysOpen}</legend>
							<@formGroup labelFor='is_open_monday'>
								<@checkBox labelFor='is_open_monday' labelKey='#i18n{appointment.label.OpenMonday}' name='is_open_monday' id='is_open_monday' value='true' checked=appointmentform.isOpenMonday!false />
							</@formGroup>
							<@formGroup labelFor='is_open_tuesday'>
								<@checkBox labelFor='is_open_tuesday' labelKey='#i18n{appointment.label.OpenTuesday}' name='is_open_tuesday' id='is_open_tuesday' value='true' checked=appointmentform.isOpenTuesday!false />
							</@formGroup>
							<@formGroup labelFor='is_open_wednesday'>
								<@checkBox labelFor='is_open_wednesday' labelKey='#i18n{appointment.label.OpenWednesday}' name='is_open_wednesday' id='is_open_wednesday' value='true' checked=appointmentform.isOpenWednesday!false />
							</@formGroup>
							<@formGroup labelFor='is_open_thursday'>
								<@checkBox labelFor='is_open_thursday' labelKey='#i18n{appointment.label.OpenThursday}' name='is_open_thursday' id='is_open_thursday' value='true' checked=appointmentform.isOpenThursday!false />
							</@formGroup>
							<@formGroup labelFor='is_open_friday'>
								<@checkBox labelFor='is_open_friday' labelKey='#i18n{appointment.label.OpenFriday}' name='is_open_friday' id='is_open_friday' value='true' checked=appointmentform.isOpenFriday!false />
							</@formGroup>
							<@formGroup labelFor='is_open_saturday'>
								<@checkBox labelFor='is_open_saturday' labelKey='#i18n{appointment.label.OpenSaturday}' name='is_open_saturday' id='is_open_saturday' value='true' checked=appointmentform.isOpenSaturday!false />
							</@formGroup>
							<@formGroup labelFor='is_open_sunday'>
								<@checkBox labelFor='is_open_sunday' labelKey='#i18n{appointment.label.OpenSunday}' name='is_open_sunday' id='is_open_sunday' value='true' checked=appointmentform.isOpenSunday!false />
							</@formGroup>
							
							<legend>#i18n{appointment.modifyAppointmentForm.startEditForm} </legend>
							<@formGroup labelFor='date_of_modification' labelKey='#i18n{appointment.modifyAppointmentForm.startDate}' helpKey='#i18n{appointment.modifyAppointmentForm.helpDateMin}' mandatory=true>
								<@inputGroup>
									<@inputGroupItem type='text'>
										<@icon style='calendar' />
									</@inputGroupItem>
									<@input type='text' name='date_of_modification' id='date_of_modification' value=appointmentform.dateOfModification!'' />
								</@inputGroup>
							</@formGroup>
							<@formGroup>
								<@button type='submit' name='action_modifyAdvancedParameters' title='#i18n{portal.util.labelModify}' buttonIcon='check' />
								<@button type='submit' name='view_manageAppointmentForms' title='#i18n{portal.util.labelCancel}' buttonIcon='times' cancel=true />
							</@formGroup>
						</@tform>
					</@boxBody>
				</@box>
				<hr color="black">
				<div id="calendar"></div>
		</@appointmentTabs>
    </@columns>
</@row>
<@getDatePickerBootstrap idField="date_of_modification" language=language />
<script type="text/javascript">
$('#date_of_modification').datepicker({
        language:        "${language}",
        startDate:         new Date(),
        weekStart: 1,
        todayBtn: true,
        todayHighLight: true,
        autoclose: true
    });
$(function () {
    $('#datetimepicker').datetimepicker({
        format: 'HH:mm',
        stepping: 5
    });
    $('#time_start').datetimepicker({
        format: 'HH:mm',
        stepping: 5
    });
    $('#time_end').datetimepicker({
        format: 'HH:mm',
        stepping: 5
    });
});
function validateQty(event) {
        var key = window.event ? event.keyCode : event.which;
    if (event.keyCode == 8 || event.keyCode == 9 || event.keyCode == 46
     || event.keyCode == 37 || event.keyCode == 39) {
        return true;
    }
    else if ( key < 48 || key > 57 ) {
        return false;
    }
    else return true;
    };
    var slotDuration = '${min_duration}';
    var minTime = '${min_time}';
    var maxTime = '${max_time}';
    var dow = [
        <#if dow??>
            <#list dow as day>
                '${day}',
            </#list>
        </#if>
    ];
    var eventUrl = 'jsp/admin/plugins/appointment/ManageAppointmentSlots.jsp?view=viewModifyTimeSlot&id_form=${appointmentform.idForm}&id_week_definition=${id_week_definition}&id_time_slot=';
    var columnFormat = 'dddd';
    var events = [
        <#if events??>
            <#list events as event>
                {
                    title : 'Capacit\u00e9 max : ' + '${event.maxCapacity}',
                    start : '${event.startingDateTime}',
                    end : '${event.endingDateTime}',
                    id : '${event.idTimeSlot}',
                    color : <#if event.isOpen>'transparent'<#else>'#bebebe'</#if>,
                    textColor: '#2c2c2d',
                    backgroundColor : <#if event.isOpen>'white'<#else>'#bebebe'</#if>,
                    borderColor : '#bebebe',
					
                },
            </#list>
        </#if>
    ];
    $( function() {
        $('#calendar').fullCalendar({
            displayEventTime: false,
            defaultView: 'agendaWeek',
            height: 'auto',
            locale: 'fr',
            themeSystem: 'jquery-ui',
            editable: false,
            header: false,
            columnFormat: columnFormat,
            slotLabelFormat: 'H:mm',
            slotLabelInterval: slotDuration,
            slotDuration: slotDuration,
            //allDaySlot: false,
            minTime: minTime,
            maxTime: maxTime,
            businessHours: {
                start: minTime,
                end: maxTime,
                dow: dow
            },
            eventClick: function(calEvent, jsEvent, view) {
                location.href = eventUrl + calEvent.id;
            },
            events: events,
            eventRender: function(event, element) {
                $(element).popover({
                	container: 'body',
                    placement : 'bottom',
                    html : true,
                    trigger : 'hover',
                    content : '<center><b>' + event.start.format('HH:mm') + '</b> - <b>' + event.end.format('HH:mm')+'</b></center>'
                });
				$(element).attr( 'data-event', '"slotId":"' + event.id +'","startDate":"' + event.start.format('DD-MM-YYYY') + '","startTime":"' + event.start.format('HH:mm') + '","endDate":"' + event.end.format('DD-MM-YYYY') + '","endTime":"' + event.end.format('HH:mm') + '"' )
         
            },
            eventAfterAllRender: function(view) {
                $('.fc-event').css('cursor', 'pointer');
            },
        });
		
		/* Event selection          */ 
        var eventIdx=0, eventData='';
		
        $( ".fc-content-skeleton" ).selectable({
            filter: ".fc-time-grid-event.fc-v-event",
            selecting: function( event, ui ) {
                eventIdx++;
            },
            unselecting: function( event, ui ) {
                eventIdx--;
            },
            stop: function() {
                console.log(  eventIdx  );   
                $( ".ui-selected", this ).each( function() {
                    console.log( eventData );
                    if ( eventIdx > 1 ){
						
						/*
                        eventData += '{' + $(this).data('event') + '};' ;
                        const events =  JSON.stringify( eventData );
                        $('#slotsData').val( '[' + events + ']' );
                        $('#updatePlanningMultiSlot').modal('show');
						*/
                    } else {
                        eventData ='{' + $(this).data('event') + '}';                       
						const evt = JSON.parse(eventData); 
                        const idSlot = JSON.parse( evt.slotId );
                
                        location.href = eventUrl + idSlot;
                    }
				
                });
                eventData='';
            }
        });
		
    });
</script>