<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/2.6.0/fullcalendar.css' />
<script src='http://code.jquery.com/jquery-1.11.3.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.1/moment.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/fullcalendar.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.2.0/locale-all.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.6.4/js/bootstrap-datepicker.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.6.4/css/bootstrap-datepicker.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.6.4/css/bootstrap-datepicker.standalone.css" />
<link href="css/plugins/appointment/appointment.css" rel="stylesheet" >
<#include "/admin/plugins/appointment/appointment/manage_appointment_tabs.html" />
<div class="row">
	<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
		<legend>
			${form.title} - #i18n{appointment.manage_appointment_calendar.pageTitle}			
		</legend>
		<@tabs tab="calendar" form=form />
		<@messages errors=errors infos=infos />
		<#if formCalendarErrors??>
			<div class="layout-wrapper">
				<@messages errors=errors />					
			</div>
		<#else>
			<div class="tab-content">
				<fieldset>									
					<div id="calendar"></div>	
				</fieldset>	
			</div>
		</#if>
	</div>
</div>
<script type="text/javascript">
	var slotDuration = '${min_duration}';
    var minTime = '${min_time}';
    var maxTime = '${max_time}';
    var dow = [
		<#if dow??>								   
			<#list dow as day>
				'${day}',								
			</#list>
		</#if>				
	];
    var nbMaxWeeks = '${nb_weeks_to_display}';
    var eventUrl = 'jsp/admin/plugins/appointment/ManageAppointments.jsp?view=';    
    var columnFormat = 'dddd DD/MM/YYYY';	
    var events = [
		<#if events??>								   
			<#list events as event>				
				<#assign nbAppointments = event.maxCapacity - event.nbRemainingPlaces>
				{					
					title : <#if modifDateAppointment??>
								'Choisir ce creneau'
							<#elseif event.isOpen & (event.nbRemainingPlaces > 0)>
								'<a href=' + eventUrl + 'manageAppointments&id_form=${event.idForm}&starting_date_time=${event.startingDateTime}&ending_date_time=${event.endingDateTime}>${nbAppointments} / ${event.maxCapacity}<a/>'
								+ '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
								+ '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'
								+ '<a href=' + eventUrl + 'createAppointment&id_form=${event.idForm}&id_slot=${event.idSlot}&starting_date_time=${event.startingDateTime}&ending_date_time=${event.endingDateTime}&is_open=${event.isOpen?c}&max_capacity=${event.maxCapacity}'+'><i class="glyphicon icon-plus-sign"></i></a>'
							<#elseif event.isOpen>
								'<a href=' + eventUrl + 'manageAppointments&id_form=${event.idForm}&starting_date_time=${event.startingDateTime}&ending_date_time=${event.endingDateTime}>${nbAppointments} / ${event.maxCapacity}<a/>'
							<#else>'#i18n{appointment.manageCalendarSlots.labelClosed}'</#if>,							
					start : '${event.startingDateTime}',
					end : '${event.endingDateTime}',
					id : '${event.idSlot}',
					color : <#if event.isOpen & (event.nbRemainingPlaces > 0) >'default'
								<#elseif event.isOpen>'red'<#else>'red'</#if>,
					url : <#if modifDateAppointment??>
							eventUrl + 'viewChangeDateAppointment&id_form=${event.idForm}&id_slot=${event.idSlot}&starting_date_time=${event.startingDateTime}&ending_date_time=${event.endingDateTime}&is_open=${event.isOpen?c}&max_capacity=${event.maxCapacity}'
							<#else>
							eventUrl + 'manageAppointments&id_form=${event.idForm}&starting_date_time=${event.startingDateTime}&ending_date_time=${event.endingDateTime}'</#if>,					
				},								
			</#list>
		</#if>
	];
	var defaultDate = '${date_of_display}';
    $(document).ready(function() {
		$('#calendar').fullCalendar({
			defaultDate: defaultDate,
			defaultView: 'agendaWeek',
			height: 'auto',			
			locale: 'fr',
			theme: true,                    
			editable: false,
			customButtons: {
				datePicker: {
					text: '#i18n{appointment.appointmentCalendar.labelChooseDate}',
					themeIcon:'circle-triangle-s',
					click: function () {
						var $btnCustom = $('.fc-datePicker-button'); // name of custom  button in the generated code
						$btnCustom.after('<input type="text" id="hiddenDate" class="datepicker"/>');
						$("#hiddenDate").datepicker({
							showOn: "button",							
							autoclose: true,
							startDate: "today",
							endDate: '+' + nbMaxWeeks + 'w',
							orientation: "bottom"
						});
						var $btnDatepicker = $(".ui-datepicker-trigger"); // name of the generated datepicker UI 
						//Below are required for manipulating dynamically created datepicker on custom button click
						$("#hiddenDate").focus().hide();
						$btnDatepicker.trigger("click"); //dynamically generated button for datepicker when clicked on input textbox
						$btnDatepicker.hide();
						$btnDatepicker.remove();
						$("input.datepicker").not(":first").remove();//dynamically appended every time on custom button click
						$("#hiddenDate").change(function () {
							$('#calendar').fullCalendar('gotoDate', $("#hiddenDate").val());
						});
					}
				}
			},
			// header
			header: {
				left: 'prev',
				center: 'today, datePicker, title',
				right: 'next'
			},
			columnFormat: columnFormat,
			slotLabelFormat: 'H:mm',
			slotLabelInterval: slotDuration,
			slotDuration: slotDuration,
			allDaySlot: false,
			minTime: minTime,
			maxTime: maxTime,         
			businessHours: {
				start: minTime,
				end: maxTime,
				dow: dow
			},
			eventClick: function(event) {
				if (event.title == '${formMessages.calendarFullLabel}' || event.title == '#i18n{appointment.manageCalendarSlots.labelClosed}') {
					return false;
				} else {
					location.href = event.url;							
				}
			},			
			events: events,
			viewRender: function(view, element) {
				var minDate = moment();
				var maxDate = moment().add(nbMaxWeeks, 'weeks');
				// Past
				if (minDate >= view.start && minDate <= view.end || view.end <= minDate) {
					$(".fc-prev-button").prop('disabled', true); 
					$(".fc-prev-button").addClass('fc-state-disabled'); 
				} else {
					$(".fc-prev-button").removeClass('fc-state-disabled'); 
					$(".fc-prev-button").prop('disabled', false); 
				}
				// Future
				if (maxDate >= view.start && maxDate <= view.end || maxDate <= view.start) {
					$(".fc-next-button").prop('disabled', true); 
					$(".fc-next-button").addClass('fc-state-disabled');  
				} else {
					$(".fc-next-button").removeClass('fc-state-disabled'); 
					$(".fc-next-button").prop('disabled', false); 
				}
			},
			eventAfterAllRender: function(view) {			
				$('.fc-event').css('cursor', 'pointer');
				$('.fc-next-button').attr('class', 'fc-next-button btn btn-primary btn-sm');
				$('.fc-prev-button').attr('class', 'fc-prev-button btn btn-primary btn-sm');
				$('.fc-today-button').attr('class', 'fc-today-button btn btn-primary btn-sm');
				$('.fc-datePicker-button').attr('class', 'fc-datePicker-button btn btn-primary btn-sm');
			},
			windowResize: function(view) {
			    if ($(window).width() < 1050){
			        $('#calendar').fullCalendar( 'changeView', 'agendaDay' );	
					$('.spanNextButton').replaceWith("<span class='spanNextButton' style='margin-right: 5px;'>#i18n{appointment.appointmentApp.nextDay}</span>");
					$('.spanPrevButton').replaceWith("<span class='spanPrevButton' style='margin-right: 5px;'>#i18n{appointment.appointmentApp.previousDay}</span>");
			    } else {
			        $('#calendar').fullCalendar( 'changeView', 'agendaWeek' );						
					$('.spanNextButton').replaceWith("<span class='spanNextButton' style='margin-right: 5px;'>#i18n{appointment.appointmentApp.nextWeek}</span>");
					$('.spanPrevButton').replaceWith("<span class='spanPrevButton' style='margin-right: 5px;'>#i18n{appointment.appointmentApp.previousWeek}</span>");
			    }
			},
			eventRender: function( event, element, view ) {				
				var $title = element.find( '.fc-title' );
				$title.html( $title.text() );
			}			
		});  		
		$('.fc-next-button').html("<span class='spanNextButton' style='margin-right: 5px;'>#i18n{appointment.appointmentApp.nextWeek}</span>" + $('.fc-next-button').html());
		$('.fc-prev-button').html($('.fc-prev-button').html() + "<span class='spanPrevButton' style='margin-left: 5px;'>#i18n{appointment.appointmentApp.previousWeek}</span>");
		$('.fc-datePicker-button').html($('.fc-datePicker-button').html() + "<span style='margin-left: 5px;'>#i18n{appointment.appointmentCalendar.labelChooseDate}</span>");
	});      
</script>